<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter Reader</title>
  <style type="text/css">
    /* Reset and Grid Layout */
    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      height: 100vh; width: 100%;
      background-color: black; color: white;
      font-family: sans-serif;
      display: grid;
      grid-template-rows: 1fr 70px;
      overflow: hidden;
    }

    #iframe { border: none; width: 100%; height: 100%; }

    .controls {
      height: 70px; background: #1a1a1a;
      display: flex; align-items: center; justify-content: center;
      gap: 15px; padding: 0 10px;
      border-top: 1px solid #333;
    }

    .control-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }

    button {
      padding: 8px 12px; background: #444; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }

    button:hover { background: #555; }
    button:disabled { opacity: 0.3; cursor: not-allowed; }

    input, select {
      background: #333; color: white;
      border: 1px solid #555; text-align: center;
      border-radius: 4px;
    }

    input[type="number"] { width: 50px; }
    select { padding: 4px; font-size: 12px; }

    label { font-size: 10px; color: #888; text-transform: uppercase; }
  </style>
</head>

<body>

  <iframe id="iframe"></iframe>

  <div class="controls">
    <button onclick="newThingy(chapter - 1)" id="back">Prev</button>

    <div class="control-item">
      <label>CH</label>
      <input id="chapterInput" type="number" onchange="newThingy(parseInt(this.value))">
    </div>

    <button onclick="newThingy(chapter + 1)" id="next">Next</button>

    <div class="control-item">
      <label>Text</label>
      <input id="textColor" type="color" onchange="changeColor('textColor', this.value)">
    </div>

    <div class="control-item">
      <label>BG</label>
      <input id="backgroundColor" type="color" onchange="changeColor('backgroundColor', this.value)">
    </div>

    <div class="control-item">
      <label>Proxy Mode</label>
      <select id="proxySelect" onchange="changeProxy(this.value)">
        <option value="none">None</option>
        <option value="codetabs">CodeTabs</option>
        <option value="google">Google Script</option>
      </select>
    </div>
  </div>

  <script type="text/javascript">
    // --- 1. INITIAL STATE ---
let chapter = parseInt(localStorage.getItem("chapter")) || 1;
let proxyMode = localStorage.getItem("proxyMode") || "none";
let currentChapterText = ""; // Store text to allow color changes without re-fetching

const iframe = document.getElementById("iframe");
const chapterInput = document.getElementById("chapterInput");
const proxySelect = document.getElementById("proxySelect");
const backBtn = document.getElementById("back");

// Sync UI on Load
window.addEventListener('DOMContentLoaded', () => {
    proxySelect.value = proxyMode;
    const txt = localStorage.getItem("textColor") || "#ffffff";
    const bg = localStorage.getItem("backgroundColor") || "#000000";
    document.getElementById("textColor").value = txt;
    document.getElementById("backgroundColor").value = bg;
    document.body.style.backgroundColor = bg;
});

// --- 2. LOGIC ---

async function fetchExternalHtml(url) {
    try {
        renderIframe(`Loading Chapter ${chapter}...`, true);
        let finalUrl = url;
        
        if (proxyMode === "codetabs") {
            finalUrl = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(url);
        } else if (proxyMode === "google") {
            const proxyBase = "https://script.google.com/macros/s/AKfycby03WWSHq6xjYdaRkaZcRiaPe8jKf4WevwDkiJrJwWY4nkQYUaBnRF1g_L7Ca33DOi-Mg/exec";
            finalUrl = `${proxyBase}?url=${encodeURIComponent(url)}`;
        }

        const response = await fetch(finalUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.text();
    } catch (error) {
        renderIframe(`Error: ${error.message}. Try a different Proxy Mode.`, true);
        return null;
    }
}

async function newThingy(ch) {
    if (ch !== undefined) chapter = ch;
    if (chapter < 1) chapter = 1;

    localStorage.setItem("chapter", chapter);
    chapterInput.value = chapter;
    backBtn.disabled = (chapter <= 1);

    // Dynamic URL - Note: Some sites use /chapter-1/ instead of /chapter-1.html
    const url = `https://freewebnovel.com/spare-me-great-lord/chapter-${chapter}.html`;
    const htmlContent = await fetchExternalHtml(url);

    if (htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');

        // Better selector: look for the article body specifically
        const contentTags = doc.querySelectorAll('.txt p, #article p');
        currentChapterText = Array.from(contentTags)
            .map(p => p.innerText.trim())
            .filter(text => text.length > 3) // Filter out tiny fragments/ads
            .join("\n\n");

        renderIframe(currentChapterText || "Content not found. Proxy might be blocked.");
    }
}

function renderIframe(content, isSystemMessage = false) {
    const textColor = localStorage.getItem("textColor") || "#ffffff";
    const backgroundColor = localStorage.getItem("backgroundColor") || "#000000";
    const alignment = isSystemMessage ? "center" : "left";

    iframe.srcdoc = `
        <html>
            <body style="background:${backgroundColor}; color:${textColor}; font-family:sans-serif; padding:40px; font-size:20px; line-height:1.7; max-width:800px; margin:0 auto; white-space:pre-wrap; text-align:${alignment};">
                ${content}
                <script>
                    window.onkeydown = e => {
                        if (e.key === 'ArrowLeft') window.parent.postMessage('goBack', '*');
                        if (e.key === 'ArrowRight') window.parent.postMessage('goNext', '*');
                    };
                <\/script>
            </body>
        </html>`;
}

function changeColor(type, value) {
    localStorage.setItem(type, value);
    if (type === "backgroundColor") document.body.style.backgroundColor = value;
    renderIframe(currentChapterText || "No content loaded");
}

// Global Listeners
window.onkeydown = e => {
    if (e.key === 'ArrowLeft' && chapter > 1) newThingy(chapter - 1);
    if (e.key === 'ArrowRight') newThingy(chapter + 1);
};

window.onmessage = e => {
    if (e.data === 'goBack') newThingy(chapter - 1);
    if (e.data === 'goNext') newThingy(chapter + 1);
};

newThingy(chapter);
  </script>
</body>
</html>

